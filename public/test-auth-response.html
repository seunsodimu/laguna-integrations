<!DOCTYPE html>
<html>
<head>
    <title>Test Auth Response</title>
</head>
<body>
    <h1>Test Authentication Response</h1>
    <button onclick="testSimple()">Test Simple Script</button>
    <button onclick="testDebugPost()">Test Debug POST</button>
    <button onclick="testCustomerSearch()">Test Customer Search</button>
    <button onclick="testComprehensiveSearch()">Test Comprehensive Search</button>
    <button onclick="testFindJoe()">Find Joe Specifically</button>
    <button onclick="testUniqueCustomer()">🔧 Test Unique Customer Logic</button>
    <button onclick="testEmailProvider()">📧 Test Email Provider</button>
    <button onclick="testNetSuiteItems()">🔧 Test NetSuite Items</button>
    <button onclick="test3DCartOrderStructure()">📋 Test 3DCart Order Structure</button>
    <button onclick="testSyncOrder1080931()">🚀 Test Sync Order 1080931</button>
    <button onclick="retrySyncOrder1080931()">🔄 Retry Sync Order 1080931</button>
    <button onclick="testDropshipFunctionality()">🚚 Test Dropship Functionality</button>
    <button onclick="findDropshipOrders()">🔍 Find Dropship Orders</button>
    <button onclick="testNewFeatures()">🆕 Test New Features</button>
    <button onclick="testCustomerCreationFix()">🔧 Test Customer Creation Fix</button>
    <button onclick="testRealCustomerCreation()">🧪 Test Real Customer Creation</button>
    <button onclick="test204ResponseFix()">🔧 Test 204 Response Fix</button>
    <button onclick="testShippingAddressMapping()">📦 Test Shipping Address Mapping</button>
    <button onclick="testCustomerAddresses()">🏠 Test Customer Addresses</button>
    <button onclick="testAddressFix()">🔧 Test Address Fix</button>
    <button onclick="testPayloadDebug()">🔍 Debug Payload</button>
    <button onclick="testRealAddressFix()">🏠 Test Real Address Fix</button>
    <button onclick="testEnsurePersonCustomer()">👤 Test Ensure Person Customer</button>
    <button onclick="checkDiscountItem()">🔍 Check Discount Item</button>
    <button onclick="testIgnoreDiscount()">🚫 Test Ignore Discount</button>
    <button onclick="testDiscountItem()">🔍 Test Discount Item</button>
    <button onclick="testDiscountFix()">🔧 Test Discount Fix</button>
    <button onclick="testDebug3DCart()">🔍 Debug 3DCart Fields</button>
    <button onclick="deleteTestOrder()">🗑️ Delete Test Order</button>
    <button onclick="testCorrectedPricing()">✅ Test Corrected Pricing</button>
    <button onclick="testTotalAdjustment()">⚖️ Test Total Adjustment</button>
    <button onclick="testDiscountSync()">💰 Test Discount Sync</button>
    <button onclick="testSyncOrder()">🚀 Test Order Sync</button>
    <button onclick="testFetch()">Test Fetch Orders</button>
    <button onclick="testDirectAccess()">Test Direct Access</button>
    <div id="result"></div>

    <script>
        function testSimple() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testing simple script...';
            
            fetch('test-simple.php', {
                method: 'POST',
                body: new FormData()
            })
            .then(response => response.text())
            .then(text => {
                console.log('Simple test response:', text);
                resultDiv.innerHTML = `
                    <h3>Simple Test Result</h3>
                    <pre>${text}</pre>
                `;
            })
            .catch(error => {
                console.error('Simple test error:', error);
                resultDiv.innerHTML = `
                    <h3>Simple Test Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }
        
        function testDiscountItem() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔍 Testing discount item configuration...';
            
            fetch('test-discount-item.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Discount item response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The discount item test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔍 Discount Item Configuration Test</h3>
                            <p><strong>Discount Item ID:</strong> ${data.discount_item_id}</p>
                            
                            <h4>📋 Current Configuration:</h4>
                            <ul>
                                <li><strong>Include Discount as Line Item:</strong> ${data.current_config.include_discount_as_line_item ? '✅ Enabled' : '❌ Disabled'}</li>
                                <li><strong>Discount Item ID:</strong> ${data.current_config.discount_item_id}</li>
                            </ul>
                        `;
                        
                        if (data.item_validation) {
                            const validation = data.item_validation;
                            html += `
                                <h4>🔍 Item Validation Results:</h4>
                                <div style="background: ${validation.exists && validation.usable ? '#d4edda' : '#f8d7da'}; padding: 10px; border: 1px solid ${validation.exists && validation.usable ? '#28a745' : '#dc3545'}; margin: 10px 0;">
                                    <p><strong>Item Exists:</strong> ${validation.exists ? '✅ Yes' : '❌ No'}</p>
                                    <p><strong>Item Usable:</strong> ${validation.usable ? '✅ Yes' : '❌ No'}</p>
                                    ${validation.error ? `<p><strong>Error:</strong> ${validation.error}</p>` : ''}
                                </div>
                            `;
                        }
                        
                        if (data.current_status) {
                            const status = data.current_status;
                            html += `
                                <h4>⚡ Current Status:</h4>
                                <div style="background: ${status.will_apply_discount ? '#d4edda' : '#fff3cd'}; padding: 10px; border: 1px solid ${status.will_apply_discount ? '#28a745' : '#ffc107'}; margin: 10px 0;">
                                    <p><strong>Discount Enabled:</strong> ${status.discount_enabled ? '✅ Yes' : '❌ No'}</p>
                                    <p><strong>Will Apply Discount:</strong> ${status.will_apply_discount ? '✅ Yes' : '❌ No'}</p>
                                    <p><strong>Issue:</strong> ${status.issue}</p>
                                </div>
                            `;
                        }
                        
                        if (data.recommendation) {
                            html += `
                                <h4>💡 Recommendation:</h4>
                                <div style="background: #e7f3ff; padding: 10px; border: 1px solid #007cba; margin: 10px 0;">
                                    <p><strong>Recommendation:</strong> ${data.recommendation}</p>
                                    <p><strong>Action Needed:</strong> ${data.action_needed}</p>
                                </div>
                            `;
                        }
                        
                        html += `
                            <details>
                                <summary>📊 Full Response</summary>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Discount Item Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Discount item test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testDiscountFix() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔧 Testing discount fix...';
            
            fetch('test-discount-fix.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Discount fix response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The discount fix test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔧 Discount Fix Test Results</h3>
                            <p><strong>Test Order ID:</strong> ${data.test_order_id}</p>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show fix status
                        if (data.fix_status) {
                            const isSuccess = data.fix_status.includes('SUCCESS');
                            html += `
                                <h4>🎯 Fix Status:</h4>
                                <div style="background: ${isSuccess ? '#d4edda' : '#f8d7da'}; padding: 15px; border: 1px solid ${isSuccess ? '#28a745' : '#dc3545'}; margin: 10px 0;">
                                    <h5 style="margin-top: 0;">${isSuccess ? '🎉 SUCCESS!' : '❌ ISSUE DETECTED'}</h5>
                                    <p><strong>Status:</strong> ${data.fix_status}</p>
                                </div>
                            `;
                        }
                        
                        // Show discount verification
                        if (data.discount_verification) {
                            const disc = data.discount_verification;
                            html += `
                                <h4>💰 Discount Verification:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Field</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">NetSuite</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                    </tr>
                                    <tr style="${disc.discount_applied ? '' : 'background: #ffe6e6;'}">
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>Discount</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">$${disc.expected_discount.toFixed(2)}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">$${disc.netsuite_discount.toFixed(2)}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${disc.discount_applied ? '✅ Match' : '❌ Mismatch'}</td>
                                    </tr>
                                </table>
                            `;
                        }
                        
                        // Show total verification
                        if (data.total_verification) {
                            const total = data.total_verification;
                            html += `
                                <h4>💵 Total Verification:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Field</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">NetSuite</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                    </tr>
                                    <tr style="${total.total_correct ? '' : 'background: #ffe6e6;'}">
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>Total</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">$${total.expected_total.toFixed(2)}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">$${total.netsuite_total.toFixed(2)}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${total.total_correct ? '✅ Match' : '❌ Mismatch'}</td>
                                    </tr>
                                </table>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Test Data & Results</summary>
                                <h5>Test Order Data:</h5>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto;">${JSON.stringify(data.test_order_data, null, 2)}</pre>
                                
                                ${data.created_order ? `
                                    <h5>Created NetSuite Order:</h5>
                                    <pre style="background: #f0f8ff; padding: 10px; border: 1px solid #007cba; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.created_order, null, 2)}</pre>
                                ` : ''}
                                
                                <h5>Full Response:</h5>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Discount Fix Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Discount fix test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testDebug3DCart() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔍 Debugging 3DCart order fields...';
            
            fetch('debug-3dcart-fields.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Debug 3DCart response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The debug test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔍 3DCart Order Field Analysis</h3>
                            <p><strong>Order ID:</strong> ${data.order_id}</p>
                        `;
                        
                        // Show discount analysis
                        if (data.discount_analysis) {
                            const disc = data.discount_analysis;
                            html += `
                                <h4>💰 Discount Analysis:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; margin: 10px 0;">
                                    <p><strong>Individual Items Total:</strong> $${disc.calculated_item_total.toFixed(2)}</p>
                                    <p><strong>3DCart OrderAmount:</strong> $${disc.order_amount.toFixed(2)}</p>
                                    <p><strong>Possible Discount:</strong> $${disc.possible_discount.toFixed(2)} (${disc.discount_percentage.toFixed(2)}%)</p>
                                </div>
                            `;
                        }
                        
                        // Show total analysis
                        if (data.total_analysis) {
                            const total = data.total_analysis;
                            html += `
                                <h4>📊 Total Analysis:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Field</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Value</th>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>OrderAmount</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">$${typeof total.OrderAmount === 'number' ? total.OrderAmount.toFixed(2) : total.OrderAmount}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>OrderTotal</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${total.OrderTotal}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>SalesTax</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${total.SalesTax}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>ShippingCost</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${total.ShippingCost}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>Calculated Final Total</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">$${total.calculated_final_total.toFixed(2)}</td>
                                    </tr>
                                </table>
                            `;
                        }
                        
                        // Show item breakdown
                        if (data.item_breakdown) {
                            html += `
                                <h4>🛒 Item Breakdown:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 12px;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 6px;">Item</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Qty</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Unit Price</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Option Price</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Effective Price</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Subtotal</th>
                                    </tr>
                            `;
                            
                            data.item_breakdown.forEach(item => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 6px; max-width: 200px; overflow: hidden;">${item.item_id}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${item.quantity}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">$${item.unit_price.toFixed(2)}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">$${item.option_price.toFixed(2)}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">$${item.effective_price.toFixed(2)}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">$${item.subtotal.toFixed(2)}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                    <tr style="background: #e9ecef; font-weight: bold;">
                                        <td colspan="5" style="border: 1px solid #ddd; padding: 6px; text-align: right;">Total:</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">$${data.calculated_item_total.toFixed(2)}</td>
                                    </tr>
                                </table>
                            `;
                        }
                        
                        // Show financial fields
                        if (data.financial_fields) {
                            html += `
                                <details>
                                    <summary>💰 All Financial Fields</summary>
                                    <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.financial_fields, null, 2)}</pre>
                                </details>
                            `;
                        }
                        
                        // Show all fields
                        html += `
                            <details>
                                <summary>📊 All Order Fields</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data.all_fields, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Debug Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Debug test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function checkDiscountItem() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔍 Checking discount item configuration...';
            
            fetch('check-discount-item.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Check discount item response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The check discount item test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔍 Discount Item Configuration Check</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show discount item status prominently
                        if (data.discount_item_status) {
                            const isValid = data.discount_item_status === 'VALID';
                            const isError = data.discount_item_status === 'DOES_NOT_EXIST' || data.discount_item_status === 'ERROR';
                            
                            html += `
                                <div style="background: ${isValid ? '#d4edda' : (isError ? '#f8d7da' : '#fff3cd')}; padding: 15px; border: 2px solid ${isValid ? '#28a745' : (isError ? '#dc3545' : '#ffc107')}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${isValid ? '#155724' : (isError ? '#721c24' : '#856404')};">
                                        ${isValid ? '✅ DISCOUNT ITEM: VALID' : (isError ? '❌ DISCOUNT ITEM: INVALID' : '⚠️ DISCOUNT ITEM: ISSUE')}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>Status:</strong> ${data.discount_item_status}</p>
                                </div>
                            `;
                        }
                        
                        // Show configured items
                        if (data.configured_items) {
                            const config = data.configured_items;
                            html += `
                                <h4>⚙️ Configured Item IDs:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Item Type</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Configured ID</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>Discount Item</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${config.discount_item_id}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.discount_item_status === 'VALID' ? '✅ Valid' : '❌ Invalid'}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>Tax Item</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${config.tax_item_id}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.tax_item_validation && data.tax_item_validation.exists ? '✅ Exists' : '❌ Missing'}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>Shipping Item</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${config.shipping_item_id}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.shipping_item_validation && data.shipping_item_validation.exists ? '✅ Exists' : '❌ Missing'}</td>
                                    </tr>
                                </table>
                            `;
                        }
                        
                        // Show discount item validation details
                        if (data.discount_item_validation) {
                            const validation = data.discount_item_validation;
                            html += `
                                <h4>🔍 Discount Item Details:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>Exists:</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.exists ? '✅ Yes' : '❌ No'}</td>
                                    </tr>
                                    ${validation.exists ? `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Item ID:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.itemid || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Display Name:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.displayname || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Item Type:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.itemtype || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Is Active:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.isinactive ? '❌ Inactive' : '✅ Active'}</td>
                                        </tr>
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Is Sale Item:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.issaleitem ? '✅ Yes' : '❌ No'}</td>
                                        </tr>
                                        <tr style="${validation.usable ? 'background: #d4edda;' : 'background: #f8d7da;'}">
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Usable:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.usable ? '✅ Yes' : '❌ No'}</td>
                                        </tr>
                                    ` : `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>Error:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.error || 'Item not found'}</td>
                                        </tr>
                                    `}
                                </table>
                            `;
                        }
                        
                        // Show available discount items
                        if (data.available_discount_items && data.available_discount_items.length > 0) {
                            html += `
                                <h4>💡 Available Discount Items in NetSuite:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0; font-size: 12px;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 6px;">ID</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Item ID</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Display Name</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Type</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Active</th>
                                        <th style="border: 1px solid #ddd; padding: 6px;">Sale Item</th>
                                    </tr>
                            `;
                            
                            data.available_discount_items.forEach(item => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-weight: bold;">${item.id}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${item.itemid}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${item.displayname}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${item.itemtype}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${item.isinactive === 'F' ? '✅' : '❌'}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${item.issaleitem === 'T' ? '✅' : '❌'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show suggestion
                        if (data.suggested_discount_item_id) {
                            html += `
                                <div style="background: #e7f3ff; padding: 15px; border: 2px solid #007cba; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: #004085;">💡 Suggested Fix:</h4>
                                    <p>Update your config file to use item ID <strong>${data.suggested_discount_item_id}</strong> instead of <strong>${data.configured_items.discount_item_id}</strong></p>
                                    <p style="margin-bottom: 0; font-size: 14px;">Change <code>discount_item_id</code> in <code>config/config.php</code> from <code>${data.configured_items.discount_item_id}</code> to <code>${data.suggested_discount_item_id}</code></p>
                                </div>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Response Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Check Discount Item Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Check discount item test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testAddressFix() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔧 Testing address creation fix...';
            
            fetch('test-address-fix.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Address fix test response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The address fix test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔧 Address Creation Fix Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status.includes('SUCCESS');
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 ADDRESS FIX: SUCCESS!' : '❌ ADDRESS FIX: FAILED!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show test results for each component
                        const tests = [
                            { key: 'customer_model_test', title: '1. Customer Model Test', icon: '👤' },
                            { key: 'order_processing_test', title: '2. OrderProcessingService Test', icon: '⚙️' },
                            { key: 'netsuite_service_test', title: '3. NetSuiteService Test', icon: '🔧' },
                            { key: 'complete_flow_test', title: '4. Complete Flow Test', icon: '🔄' }
                        ];
                        
                        tests.forEach(test => {
                            if (data[test.key]) {
                                const testData = data[test.key];
                                const hasRequiredFields = test.key === 'customer_model_test' ? testData.has_billing_fields :
                                                         test.key === 'order_processing_test' ? testData.has_billing_fields :
                                                         test.key === 'netsuite_service_test' ? testData.has_default_address :
                                                         testData.has_addressbook;
                                
                                const bgColor = hasRequiredFields ? '#d4edda' : '#f8d7da';
                                const borderColor = hasRequiredFields ? '#28a745' : '#dc3545';
                                
                                html += `
                                    <div style="background: ${bgColor}; padding: 10px; border: 1px solid ${borderColor}; border-radius: 5px; margin: 10px 0;">
                                        <h5>${test.icon} ${test.title} ${hasRequiredFields ? '✅' : '❌'}</h5>
                                `;
                                
                                if (test.key === 'customer_model_test') {
                                    html += `
                                        <p><strong>Billing Fields Present:</strong></p>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; font-size: 12px;">
                                    `;
                                    Object.entries(testData.billing_fields_present).forEach(([field, present]) => {
                                        html += `<span>${field}: ${present ? '✅' : '❌'}</span>`;
                                    });
                                    html += `</div>`;
                                    html += `<p><strong>Has ShipmentList:</strong> ${testData.has_shipment_list ? '✅' : '❌'}</p>`;
                                    
                                } else if (test.key === 'order_processing_test') {
                                    html += `
                                        <p><strong>Billing Fields Present:</strong></p>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; font-size: 12px;">
                                    `;
                                    Object.entries(testData.billing_fields_present).forEach(([field, present]) => {
                                        html += `<span>${field}: ${present ? '✅' : '❌'}</span>`;
                                    });
                                    html += `</div>`;
                                    html += `<p><strong>Has ShipmentList:</strong> ${testData.has_shipment_list ? '✅' : '❌'}</p>`;
                                    
                                } else if (test.key === 'netsuite_service_test') {
                                    html += `
                                        <p><strong>Default Address:</strong> ${testData.has_default_address ? '✅ Created' : '❌ Missing'}</p>
                                        <p><strong>Addressbook Items:</strong> ${testData.addressbook_items}</p>
                                        <p><strong>Billing Address:</strong> ${testData.has_billing_address ? '✅' : '❌'}</p>
                                        <p><strong>Shipping Address:</strong> ${testData.has_shipping_address ? '✅' : '❌'}</p>
                                    `;
                                    
                                } else if (test.key === 'complete_flow_test') {
                                    html += `
                                        <p><strong>Default Address:</strong> ${testData.has_default_address ? '✅ Created' : '❌ Missing'}</p>
                                        <p><strong>Addressbook:</strong> ${testData.has_addressbook ? '✅ Created' : '❌ Missing'}</p>
                                        <p><strong>Addressbook Items:</strong> ${testData.addressbook_items}</p>
                                    `;
                                }
                                
                                html += '</div>';
                            }
                        });
                        
                        // Show validation results
                        if (data.validations) {
                            html += `
                                <h4>✅ Validation Results:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Component</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Validation</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Result</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.validations).forEach(([key, validation]) => {
                                const bgColor = validation.correct ? '#d4edda' : '#f8d7da';
                                const component = key.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                                html += `
                                    <tr style="background: ${bgColor};">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${component}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.description}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ Working' : '❌ Broken'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show example data
                        if (data.complete_flow_test && data.complete_flow_test.final_netsuite_customer) {
                            html += `
                                <h4>📄 Example Final NetSuite Customer Object:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <h5>defaultAddress:</h5>
                                    <pre style="background: #e9ecef; padding: 8px; border-radius: 3px; font-size: 11px; white-space: pre-wrap;">${data.complete_flow_test.final_netsuite_customer.defaultAddress || '(empty)'}</pre>
                                    
                                    <h5>addressbook:</h5>
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        <pre style="background: #e9ecef; padding: 8px; border-radius: 3px; font-size: 11px;">${JSON.stringify(data.complete_flow_test.final_netsuite_customer.addressbook, null, 2)}</pre>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Show what was fixed
                        html += `
                            <h4>🔧 What Was Fixed:</h4>
                            <div style="background: #fff3cd; padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
                                <p><strong>1. Customer Model:</strong> Updated toNetSuiteFormat() to include raw billing fields and ShipmentList</p>
                                <p><strong>2. OrderProcessingService:</strong> Updated extractCustomerInfo() to include all billing and shipping fields</p>
                                <p><strong>3. Data Flow:</strong> Ensured address creation methods receive the data they need</p>
                                <p><strong>4. Addressbook Population:</strong> Fixed the missing addressbook items issue</p>
                            </div>
                        `;
                        
                        // Show next steps
                        if (data.validation_result === 'success') {
                            html += `
                                <h4>🚀 Next Steps (Success):</h4>
                                <div style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 5px;">
                                    <p>✅ <strong>The address fix is working!</strong> You can now:</p>
                                    <p>1. Create customers and verify they have complete address information</p>
                                    <p>2. Check that addressbook is populated with billing and shipping addresses</p>
                                    <p>3. Process orders and see proper customer address creation</p>
                                    <p>4. Monitor logs to confirm address creation is working</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <h4>🔧 Next Steps (Issues Found):</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px;">
                                    <p>❌ <strong>Issues detected:</strong> You should:</p>
                                    <p>1. Review the validation failures above</p>
                                    <p>2. Check the data flow between components</p>
                                    <p>3. Verify the address creation methods are working</p>
                                    <p>4. Test with real order data</p>
                                </div>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Address Fix Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                            ${data.trace ? `<pre style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; max-height: 300px; overflow-y: auto;">${data.trace}</pre>` : ''}
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Address fix test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testPayloadDebug() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔍 Testing payload generation vs expected format...';
            
            fetch('test-payload-debug.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Payload debug response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The payload debug test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔍 Customer Payload Debug Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show status
                        if (data.status) {
                            const isSuccess = data.status === 'success';
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 PAYLOAD GENERATION: SUCCESS!' : '❌ PAYLOAD GENERATION: ISSUES FOUND!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>Status: ${data.status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show issues if any
                        if (data.issues_found && data.issues_found.length > 0) {
                            html += `
                                <h4>⚠️ Issues Found:</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px;">
                                    <ul>
                            `;
                            data.issues_found.forEach(issue => {
                                html += `<li>${issue}</li>`;
                            });
                            html += '</ul></div>';
                        }
                        
                        // Show expected vs actual comparison
                        if (data.detailed_comparison) {
                            html += `
                                <h4>📊 Expected vs Actual Payload Comparison:</h4>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 15px 0;">
                                    <div>
                                        <h5>Expected Payload:</h5>
                                        <pre style="background: #e7f3ff; padding: 8px; border: 1px solid #0066cc; border-radius: 3px; font-size: 10px; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.detailed_comparison.expected_payload, null, 2)}</pre>
                                    </div>
                                    <div>
                                        <h5>Customer Model Result:</h5>
                                        <pre style="background: #f8f9fa; padding: 8px; border: 1px solid #dee2e6; border-radius: 3px; font-size: 10px; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.detailed_comparison.customer_model_payload, null, 2)}</pre>
                                    </div>
                                    <div>
                                        <h5>OrderProcessing Result:</h5>
                                        <pre style="background: #f8f9fa; padding: 8px; border: 1px solid #dee2e6; border-radius: 3px; font-size: 10px; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.detailed_comparison.order_processing_payload, null, 2)}</pre>
                                    </div>
                                </div>
                            `;
                            
                            // Field by field comparison
                            if (data.detailed_comparison.field_by_field_comparison) {
                                html += `
                                    <h4>🔍 Field-by-Field Comparison:</h4>
                                    
                                    <h5>Basic Fields:</h5>
                                    <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                        <tr style="background: #f0f0f0;">
                                            <th style="border: 1px solid #ddd; padding: 8px;">Field</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Customer Model</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">OrderProcessing</th>
                                        </tr>
                                `;
                                
                                Object.entries(data.detailed_comparison.field_by_field_comparison.basic_fields).forEach(([field, values]) => {
                                    const customerMatch = values.expected === values.customer_model;
                                    const orderMatch = values.expected === values.order_processing;
                                    
                                    html += `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${field}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${values.expected}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; background: ${customerMatch ? '#d4edda' : '#f8d7da'};">${values.customer_model} ${customerMatch ? '✅' : '❌'}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; background: ${orderMatch ? '#d4edda' : '#f8d7da'};">${values.order_processing} ${orderMatch ? '✅' : '❌'}</td>
                                        </tr>
                                    `;
                                });
                                
                                html += `
                                    </table>
                                    
                                    <h5>Address Fields:</h5>
                                    <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                        <tr style="background: #f0f0f0;">
                                            <th style="border: 1px solid #ddd; padding: 8px;">Field</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">Customer Model</th>
                                            <th style="border: 1px solid #ddd; padding: 8px;">OrderProcessing</th>
                                        </tr>
                                `;
                                
                                Object.entries(data.detailed_comparison.field_by_field_comparison.address_fields).forEach(([field, values]) => {
                                    const customerMatch = values.expected === values.customer_model;
                                    const orderMatch = values.expected === values.order_processing;
                                    
                                    html += `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${field}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${values.expected}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; background: ${customerMatch ? '#d4edda' : '#f8d7da'};">${values.customer_model} ${customerMatch ? '✅' : '❌'}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px; background: ${orderMatch ? '#d4edda' : '#f8d7da'};">${values.order_processing} ${orderMatch ? '✅' : '❌'}</td>
                                        </tr>
                                    `;
                                });
                                
                                html += '</table>';
                            }
                        }
                        
                        // Show comparison results
                        if (data.comparison) {
                            html += `
                                <h4>📋 Comparison Results:</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <h5>Customer Model vs Expected:</h5>
                                        <table style="border-collapse: collapse; width: 100%;">
                            `;
                            
                            Object.entries(data.comparison.expected_vs_customer_model).forEach(([key, value]) => {
                                const bgColor = value ? '#d4edda' : '#f8d7da';
                                html += `
                                    <tr style="background: ${bgColor};">
                                        <td style="border: 1px solid #ddd; padding: 6px;">${key.replace(/_/g, ' ')}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${value ? '✅ Match' : '❌ Mismatch'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        </table>
                                    </div>
                                    <div>
                                        <h5>OrderProcessing vs Expected:</h5>
                                        <table style="border-collapse: collapse; width: 100%;">
                            `;
                            
                            Object.entries(data.comparison.expected_vs_order_processing).forEach(([key, value]) => {
                                const bgColor = value ? '#d4edda' : '#f8d7da';
                                html += `
                                    <tr style="background: ${bgColor};">
                                        <td style="border: 1px solid #ddd; padding: 6px;">${key.replace(/_/g, ' ')}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${value ? '✅ Match' : '❌ Mismatch'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table></div></div>';
                        }
                        
                        // Show test results summary
                        if (data.customer_model_result && data.order_processing_result) {
                            html += `
                                <h4>📊 Test Results Summary:</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                        <h5>Customer Model Approach:</h5>
                                        <p><strong>Default Address:</strong> ${data.customer_model_result.has_default_address ? '✅ Present' : '❌ Missing'}</p>
                                        <p><strong>Addressbook:</strong> ${data.customer_model_result.has_addressbook ? '✅ Present' : '❌ Missing'}</p>
                                        <p><strong>Addressbook Items:</strong> ${data.customer_model_result.addressbook_items}</p>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                        <h5>OrderProcessing Approach:</h5>
                                        <p><strong>Default Address:</strong> ${data.order_processing_result.has_default_address ? '✅ Present' : '❌ Missing'}</p>
                                        <p><strong>Addressbook:</strong> ${data.order_processing_result.has_addressbook ? '✅ Present' : '❌ Missing'}</p>
                                        <p><strong>Addressbook Items:</strong> ${data.order_processing_result.addressbook_items}</p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Show next steps
                        if (data.status === 'success') {
                            html += `
                                <h4>🚀 Next Steps (Success):</h4>
                                <div style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 5px;">
                                    <p>✅ <strong>Payload generation is working correctly!</strong></p>
                                    <p>The generated payloads match the expected format. Customer creation should work properly.</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <h4>🔧 Next Steps (Issues Found):</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px;">
                                    <p>❌ <strong>Issues found in payload generation:</strong></p>
                                    <p>Review the comparison above to identify what needs to be fixed.</p>
                                    <p>Focus on the fields marked with ❌ in the comparison tables.</p>
                                </div>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Debug Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Payload Debug Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                            ${data.trace ? `<pre style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; max-height: 300px; overflow-y: auto;">${data.trace}</pre>` : ''}
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Payload debug test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testRealAddressFix() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🏠 Testing real customer creation with address fix...';
            
            fetch('test-real-customer-creation.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Real address fix response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The real address fix test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🏠 Real Customer Creation with Address Fix Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show final result
                        if (data.final_result) {
                            const isSuccess = data.status === 'success';
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 REAL ADDRESS FIX: SUCCESS!' : '❌ REAL ADDRESS FIX: ISSUES FOUND!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.final_result}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show address verification if available
                        if (data.address_verification) {
                            html += `
                                <h4>🔍 Address Verification:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <p><strong>Default Address:</strong> ${data.address_verification.has_default_address ? '✅ Present' : '❌ Missing'}</p>
                                    <p><strong>Default Address Value:</strong> "${data.address_verification.default_address_value}"</p>
                                    <p><strong>Addressbook:</strong> ${data.address_verification.has_addressbook ? '✅ Present' : '❌ Missing'}</p>
                                    <p><strong>Addressbook Items:</strong> ${data.address_verification.addressbook_items_count}</p>
                                </div>
                            `;
                        }
                        
                        // Show address comparison if available
                        if (data.address_comparison) {
                            html += `
                                <h4>📊 Address Comparison:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Field</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actual</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Match</th>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Default Address</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.address_comparison.expected_default_address}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.address_comparison.actual_default_address}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; background: ${data.address_comparison.default_address_matches ? '#d4edda' : '#f8d7da'};">
                                            ${data.address_comparison.default_address_matches ? '✅ Yes' : '❌ No'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Addressbook Items</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.address_comparison.expected_addressbook_items}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.address_comparison.actual_addressbook_items}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; background: ${data.address_comparison.addressbook_count_matches ? '#d4edda' : '#f8d7da'};">
                                            ${data.address_comparison.addressbook_count_matches ? '✅ Yes' : '❌ No'}
                                        </td>
                                    </tr>
                                </table>
                            `;
                        }
                        
                        // Show customer creation result
                        if (data.customer_creation_result) {
                            html += `
                                <h4>👤 Customer Creation Result:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <p><strong>Success:</strong> ${data.customer_creation_result.success ? '✅ Yes' : '❌ No'}</p>
                                    <p><strong>Customer ID:</strong> ${data.customer_creation_result.customer_id || 'N/A'}</p>
                                    <p><strong>Message:</strong> ${data.customer_creation_result.message || 'N/A'}</p>
                                </div>
                            `;
                        }
                        
                        // Show extracted customer info
                        if (data.extracted_customer_info) {
                            html += `
                                <details>
                                    <summary>📋 Extracted Customer Info</summary>
                                    <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.extracted_customer_info, null, 2)}</pre>
                                </details>
                            `;
                        }
                        
                        // Show created customer verification
                        if (data.created_customer_verification) {
                            html += `
                                <details>
                                    <summary>✅ Created Customer Verification</summary>
                                    <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.created_customer_verification, null, 2)}</pre>
                                </details>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Real Address Fix Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                            ${data.trace ? `<pre style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; max-height: 300px; overflow-y: auto;">${data.trace}</pre>` : ''}
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Real address fix test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testEnsurePersonCustomer() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '👤 Testing ensurePersonCustomer method with address creation...';
            
            fetch('test-ensure-person-customer.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Ensure person customer response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The ensure person customer test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>👤 Ensure Person Customer Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show final result
                        if (data.final_result) {
                            const isSuccess = data.status === 'success';
                            const isPartial = data.status === 'partial_success';
                            const bgColor = isSuccess ? '#d4edda' : (isPartial ? '#fff3cd' : '#f8d7da');
                            const borderColor = isSuccess ? '#28a745' : (isPartial ? '#ffc107' : '#dc3545');
                            const textColor = isSuccess ? '#155724' : (isPartial ? '#856404' : '#721c24');
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 ENSURE PERSON CUSTOMER: SUCCESS!' : 
                                          isPartial ? '⚠️ ENSURE PERSON CUSTOMER: PARTIAL SUCCESS!' : 
                                          '❌ ENSURE PERSON CUSTOMER: ISSUES FOUND!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.final_result}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show execution info
                        if (data.execution_time_ms) {
                            html += `
                                <h4>⏱️ Execution Info:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <p><strong>Execution Time:</strong> ${data.execution_time_ms.toFixed(2)}ms</p>
                                    <p><strong>Created New Person:</strong> ${data.created_new_person ? '✅ Yes' : '❌ No'}</p>
                                </div>
                            `;
                        }
                        
                        // Show address verification if available
                        if (data.address_verification) {
                            html += `
                                <h4>🔍 Address Verification:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <p><strong>Default Address:</strong> ${data.address_verification.has_default_address ? '✅ Present' : '❌ Missing'}</p>
                                    <p><strong>Default Address Value:</strong> "${data.address_verification.default_address_value}"</p>
                                    <p><strong>Addressbook:</strong> ${data.address_verification.has_addressbook ? '✅ Present' : '❌ Missing'}</p>
                                    <p><strong>Addressbook Items:</strong> ${data.address_verification.addressbook_items_count}</p>
                                </div>
                            `;
                        }
                        
                        // Show address comparison if available
                        if (data.address_comparison) {
                            html += `
                                <h4>📊 Address Comparison:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Field</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actual</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Match</th>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Default Address</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.address_comparison.expected_default_address}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.address_comparison.actual_default_address}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; background: ${data.address_comparison.default_address_matches ? '#d4edda' : '#f8d7da'};">
                                            ${data.address_comparison.default_address_matches ? '✅ Yes' : '❌ No'}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Addressbook Items</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.address_comparison.expected_addressbook_items}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${data.address_comparison.actual_addressbook_items}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; background: ${data.address_comparison.addressbook_count_matches ? '#d4edda' : '#f8d7da'};">
                                            ${data.address_comparison.addressbook_count_matches ? '✅ Yes' : '❌ No'}
                                        </td>
                                    </tr>
                                </table>
                            `;
                        }
                        
                        // Show company customer info
                        if (data.company_customer) {
                            html += `
                                <details>
                                    <summary>🏢 Company Customer Used</summary>
                                    <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto;">${JSON.stringify(data.company_customer, null, 2)}</pre>
                                </details>
                            `;
                        }
                        
                        // Show person customer result
                        if (data.person_customer_result) {
                            html += `
                                <details>
                                    <summary>👤 Person Customer Result</summary>
                                    <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto;">${JSON.stringify(data.person_customer_result, null, 2)}</pre>
                                </details>
                            `;
                        }
                        
                        // Show full person customer verification
                        if (data.full_person_customer) {
                            html += `
                                <details>
                                    <summary>✅ Full Person Customer Verification</summary>
                                    <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.full_person_customer, null, 2)}</pre>
                                </details>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Ensure Person Customer Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                            ${data.trace ? `<pre style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; max-height: 300px; overflow-y: auto;">${data.trace}</pre>` : ''}
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Ensure person customer test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testCustomerAddresses() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🏠 Testing customer address creation...';
            
            fetch('test-customer-addresses.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Customer addresses test response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The customer addresses test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🏠 Customer Address Creation Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status.includes('SUCCESS');
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 CUSTOMER ADDRESSES: SUCCESS!' : '❌ CUSTOMER ADDRESSES: FAILED!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show address requirements
                        if (data.address_requirements) {
                            html += `
                                <h4>📋 Address Requirements:</h4>
                                <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px; margin: 10px 0;">
                                    <h5>defaultAddress (Multi-line String):</h5>
                                    <ul>
                            `;
                            
                            data.address_requirements.defaultAddress.structure.forEach(line => {
                                html += `<li>${line}</li>`;
                            });
                            
                            html += `
                                    </ul>
                                    
                                    <h5>addressbook (Object with Items Array):</h5>
                                    <p><strong>Billing Address:</strong> defaultBilling: true, defaultShipping: false</p>
                                    <p><strong>Shipping Address:</strong> defaultBilling: false, defaultShipping: true</p>
                                </div>
                            `;
                        }
                        
                        // Show test scenarios and results
                        if (data.simulation_results) {
                            html += `
                                <h4>🧪 Test Scenarios and Results:</h4>
                            `;
                            
                            Object.entries(data.simulation_results).forEach(([key, result]) => {
                                const bgColor = result.has_default_address && result.has_billing_address ? '#d4edda' : '#fff3cd';
                                const borderColor = result.has_default_address && result.has_billing_address ? '#28a745' : '#ffc107';
                                
                                html += `
                                    <div style="background: ${bgColor}; padding: 10px; border: 1px solid ${borderColor}; border-radius: 5px; margin: 10px 0;">
                                        <h5>${result.scenario}</h5>
                                        
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                            <div>
                                                <h6>Input Data (3DCart):</h6>
                                                <table style="border-collapse: collapse; width: 100%; font-size: 11px;">
                                `;
                                
                                // Show key input fields
                                const keyFields = ['BillingFirstName', 'BillingLastName', 'BillingCompany', 'BillingAddress', 'BillingCity', 'BillingState', 'BillingZipCode', 'BillingCountry', 'BillingPhoneNumber'];
                                keyFields.forEach(field => {
                                    if (result.input_data[field] !== undefined) {
                                        html += `
                                            <tr>
                                                <td style="border: 1px solid #ddd; padding: 3px; font-weight: bold;">${field}</td>
                                                <td style="border: 1px solid #ddd; padding: 3px;">${result.input_data[field] || '(empty)'}</td>
                                            </tr>
                                        `;
                                    }
                                });
                                
                                // Show ShipmentList if present
                                if (result.input_data.ShipmentList && result.input_data.ShipmentList.length > 0) {
                                    const shipment = result.input_data.ShipmentList[0];
                                    html += `
                                        <tr style="background: #f0f0f0;">
                                            <td colspan="2" style="border: 1px solid #ddd; padding: 3px; font-weight: bold;">ShipmentList[0]:</td>
                                        </tr>
                                    `;
                                    Object.entries(shipment).forEach(([field, value]) => {
                                        html += `
                                            <tr>
                                                <td style="border: 1px solid #ddd; padding: 3px; padding-left: 15px;">${field}</td>
                                                <td style="border: 1px solid #ddd; padding: 3px;">${value || '(empty)'}</td>
                                            </tr>
                                        `;
                                    });
                                }
                                
                                html += `
                                                </table>
                                            </div>
                                            <div>
                                                <h6>NetSuite Customer Object:</h6>
                                                
                                                <h7><strong>defaultAddress:</strong></h7>
                                                <pre style="background: #f8f9fa; padding: 5px; border: 1px solid #dee2e6; font-size: 10px; white-space: pre-wrap; margin: 5px 0;">${result.netsuite_customer.defaultAddress || '(empty)'}</pre>
                                                
                                                <h7><strong>addressbook:</strong></h7>
                                                <div style="max-height: 200px; overflow-y: auto;">
                                                    <pre style="background: #f8f9fa; padding: 5px; border: 1px solid #dee2e6; font-size: 10px;">${JSON.stringify(result.netsuite_customer.addressbook, null, 2)}</pre>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 3px;">
                                            <p style="margin: 0; font-size: 12px;">
                                                <strong>Results:</strong>
                                                Default Address: ${result.has_default_address ? '✅ Created' : '❌ Missing'} |
                                                Addressbook Items: ${result.addressbook_items} |
                                                Billing: ${result.has_billing_address ? '✅' : '❌'} |
                                                Shipping: ${result.has_shipping_address ? '✅' : '❌'}
                                            </p>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                        
                        // Show implementation details
                        if (data.implementation_details) {
                            html += `
                                <h4>💻 Implementation Details:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <h5>New Methods Added:</h5>
                                    <ul>
                            `;
                            
                            Object.entries(data.implementation_details.new_methods_added).forEach(([method, description]) => {
                                html += `<li><strong>${method}:</strong> ${description}</li>`;
                            });
                            
                            html += `
                                    </ul>
                                    
                                    <h5>Field Mapping:</h5>
                                    <table style="border-collapse: collapse; width: 100%; margin: 5px 0;">
                                        <tr style="background: #f0f0f0;">
                                            <th style="border: 1px solid #ddd; padding: 6px;">NetSuite Field</th>
                                            <th style="border: 1px solid #ddd; padding: 6px;">Source</th>
                                            <th style="border: 1px solid #ddd; padding: 6px;">Format</th>
                                            <th style="border: 1px solid #ddd; padding: 6px;">Details</th>
                                        </tr>
                            `;
                            
                            Object.entries(data.implementation_details.field_mapping).forEach(([field, details]) => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-weight: bold;">${field}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${details.source}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${details.format || details.defaultBilling !== undefined ? 'Object' : 'N/A'}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-size: 11px;">${details.includes || details.fields || (details.defaultBilling !== undefined ? `defaultBilling: ${details.defaultBilling}, defaultShipping: ${details.defaultShipping}` : '')}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table></div>';
                        }
                        
                        // Show validation results
                        if (data.validations) {
                            html += `
                                <h4>✅ Validation Results:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Validation</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Result</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.validations).forEach(([key, validation]) => {
                                const bgColor = validation.correct ? '#d4edda' : '#f8d7da';
                                html += `
                                    <tr style="background: ${bgColor};">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${validation.description}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ Implemented' : '❌ Failed'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show what this update accomplishes
                        html += `
                            <h4>🎯 What This Update Accomplishes:</h4>
                            <div style="background: #fff3cd; padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
                                <p><strong>1. Complete Address Data:</strong> Customers get both defaultAddress string and structured addressbook</p>
                                <p><strong>2. Billing Address:</strong> Always included when billing data is available</p>
                                <p><strong>3. Shipping Address:</strong> Included when ShipmentList data is available</p>
                                <p><strong>4. NetSuite Integration:</strong> Proper address format for NetSuite customer records</p>
                                <p><strong>5. Data Completeness:</strong> All address components mapped from 3DCart to NetSuite</p>
                            </div>
                        `;
                        
                        // Show example defaultAddress format
                        if (data.simulation_results && data.simulation_results.complete_data) {
                            html += `
                                <h4>📄 Example defaultAddress Format:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <pre style="background: #e9ecef; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap;">${data.simulation_results.complete_data.netsuite_customer.defaultAddress}</pre>
                                </div>
                            `;
                        }
                        
                        // Show next steps
                        if (data.validation_result === 'success') {
                            html += `
                                <h4>🚀 Next Steps (Success):</h4>
                                <div style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 5px;">
                                    <p>✅ <strong>Customer address creation is ready!</strong> You can now:</p>
                                    <p>1. Create customers with complete address information</p>
                                    <p>2. Verify defaultAddress appears correctly in NetSuite</p>
                                    <p>3. Check that addressbook has billing and shipping addresses</p>
                                    <p>4. Monitor logs to see address creation details</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <h4>🔧 Next Steps (Issues Found):</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px;">
                                    <p>❌ <strong>Issues detected:</strong> You should:</p>
                                    <p>1. Review the validation failures above</p>
                                    <p>2. Test with real 3DCart customer data</p>
                                    <p>3. Verify the address field mappings</p>
                                    <p>4. Check NetSuite address requirements</p>
                                </div>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Customer Addresses Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Customer addresses test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testShippingAddressMapping() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '📦 Testing shipping address mapping...';
            
            fetch('test-shipping-address-mapping.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Shipping address mapping test response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The shipping address mapping test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>📦 Shipping Address Mapping Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status.includes('SUCCESS');
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 SHIPPING MAPPING: SUCCESS!' : '❌ SHIPPING MAPPING: FAILED!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show mapping requirements
                        if (data.mapping_requirements) {
                            html += `
                                <h4>📋 Mapping Requirements:</h4>
                                <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px; margin: 10px 0;">
                                    <p><strong>Source:</strong> ${data.mapping_requirements.source}</p>
                                    <p><strong>Destination:</strong> ${data.mapping_requirements.destination}</p>
                                    
                                    <h5>Addressee Logic:</h5>
                                    <ul>
                                        <li><strong>If Company Not Empty:</strong> ${data.mapping_requirements.addressee_logic.if_company_not_empty}</li>
                                        <li><strong>If Company Empty:</strong> ${data.mapping_requirements.addressee_logic.if_company_empty}</li>
                                    </ul>
                                    
                                    <h5>Field Mapping:</h5>
                                    <table style="border-collapse: collapse; width: 100%; margin: 5px 0;">
                                        <tr style="background: #f0f0f0;">
                                            <th style="border: 1px solid #ddd; padding: 6px;">NetSuite Field</th>
                                            <th style="border: 1px solid #ddd; padding: 6px;">3DCart Source</th>
                                        </tr>
                            `;
                            
                            Object.entries(data.mapping_requirements.field_mapping).forEach(([netsuiteField, source]) => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 6px; font-weight: bold;">${netsuiteField}</td>
                                        <td style="border: 1px solid #ddd; padding: 6px;">${source}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table></div>';
                        }
                        
                        // Show test scenarios and results
                        if (data.simulation_results) {
                            html += `
                                <h4>🧪 Test Scenarios and Results:</h4>
                            `;
                            
                            Object.entries(data.simulation_results).forEach(([key, result]) => {
                                const bgColor = result.addressee_correct ? '#d4edda' : '#f8d7da';
                                const borderColor = result.addressee_correct ? '#28a745' : '#dc3545';
                                
                                html += `
                                    <div style="background: ${bgColor}; padding: 10px; border: 1px solid ${borderColor}; border-radius: 5px; margin: 10px 0;">
                                        <h5>${result.scenario} ${result.addressee_correct ? '✅' : '❌'}</h5>
                                        
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                            <div>
                                                <h6>Input Data (3DCart ShipmentList):</h6>
                                                <table style="border-collapse: collapse; width: 100%; font-size: 12px;">
                                `;
                                
                                Object.entries(result.input_data).forEach(([field, value]) => {
                                    html += `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 4px; font-weight: bold;">${field}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px;">${value || '(empty)'}</td>
                                        </tr>
                                    `;
                                });
                                
                                html += `
                                                </table>
                                            </div>
                                            <div>
                                                <h6>Output (NetSuite shipAddress):</h6>
                                                <table style="border-collapse: collapse; width: 100%; font-size: 12px;">
                                `;
                                
                                Object.entries(result.simulated_address).forEach(([field, value]) => {
                                    html += `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 4px; font-weight: bold;">${field}</td>
                                            <td style="border: 1px solid #ddd; padding: 4px;">${value}</td>
                                        </tr>
                                    `;
                                });
                                
                                html += `
                                                </table>
                                            </div>
                                        </div>
                                        
                                        <p style="margin-top: 10px; margin-bottom: 0;">
                                            <strong>Addressee Source:</strong> ${result.addressee_source}<br>
                                            <strong>Expected:</strong> "${result.expected_addressee}"<br>
                                            <strong>Actual:</strong> "${result.actual_addressee}"<br>
                                            <strong>Result:</strong> ${result.addressee_correct ? '✅ CORRECT' : '❌ INCORRECT'}
                                        </p>
                                    </div>
                                `;
                            });
                        }
                        
                        // Show code changes
                        if (data.code_changes) {
                            html += `
                                <h4>💻 Code Changes Made:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <p><strong>File:</strong> ${data.code_changes.file}</p>
                                    <p><strong>Method:</strong> ${data.code_changes.method}</p>
                                    
                                    <h5>❌ Before (Issues):</h5>
                                    <p>${data.code_changes.before.description}</p>
                                    <ul>
                            `;
                            
                            data.code_changes.before.issues.forEach(issue => {
                                html += `<li>${issue}</li>`;
                            });
                            
                            html += `
                                    </ul>
                                    
                                    <h5>✅ After (Fixed):</h5>
                                    <p>${data.code_changes.after.description}</p>
                                    <ul>
                            `;
                            
                            data.code_changes.after.improvements.forEach(improvement => {
                                html += `<li>${improvement}</li>`;
                            });
                            
                            html += '</ul></div>';
                        }
                        
                        // Show validation results
                        if (data.validations) {
                            html += `
                                <h4>✅ Validation Results:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Validation</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Result</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.validations).forEach(([key, validation]) => {
                                const bgColor = validation.correct ? '#d4edda' : '#f8d7da';
                                html += `
                                    <tr style="background: ${bgColor};">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${validation.description}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ Implemented' : '❌ Failed'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show example outputs
                        if (data.example_outputs) {
                            html += `
                                <h4>📄 Example NetSuite shipAddress Objects:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                            `;
                            
                            Object.entries(data.example_outputs).forEach(([key, example]) => {
                                html += `
                                    <h5>${example.scenario}:</h5>
                                    <pre style="background: #e9ecef; padding: 8px; border-radius: 3px; font-size: 12px; overflow-x: auto;">${JSON.stringify(example.netsuite_shipAddress, null, 2)}</pre>
                                `;
                            });
                            
                            html += '</div>';
                        }
                        
                        // Show what this update accomplishes
                        html += `
                            <h4>🎯 What This Update Accomplishes:</h4>
                            <div style="background: #fff3cd; padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
                                <p><strong>1. Correct Field Mapping:</strong> Uses ShipmentList fields instead of old ShippingAddress fields</p>
                                <p><strong>2. Smart Addressee Logic:</strong> Uses company name when available, falls back to person name</p>
                                <p><strong>3. Complete Address Data:</strong> Maps all available shipping address components</p>
                                <p><strong>4. Data Integrity:</strong> Ensures NetSuite gets accurate shipping information</p>
                                <p><strong>5. Backward Compatibility:</strong> Handles missing or empty fields gracefully</p>
                            </div>
                        `;
                        
                        // Show next steps
                        if (data.validation_result === 'success') {
                            html += `
                                <h4>🚀 Next Steps (Success):</h4>
                                <div style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 5px;">
                                    <p>✅ <strong>Shipping address mapping is ready!</strong> You can now:</p>
                                    <p>1. Process orders and verify shipping addresses in NetSuite</p>
                                    <p>2. Check that company names appear correctly as addressee</p>
                                    <p>3. Verify person names are used when company is empty</p>
                                    <p>4. Monitor logs to see shipping address creation</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <h4>🔧 Next Steps (Issues Found):</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px;">
                                    <p>❌ <strong>Issues detected:</strong> You should:</p>
                                    <p>1. Review the validation failures above</p>
                                    <p>2. Test with real 3DCart order data</p>
                                    <p>3. Verify the ShipmentList field names are correct</p>
                                    <p>4. Check NetSuite shipAddress requirements</p>
                                </div>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Shipping Address Mapping Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Shipping address mapping test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function test204ResponseFix() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔧 Testing 204 response fix...';
            
            fetch('test-204-response-fix.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('204 response fix test response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The 204 response fix test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔧 204 Response Fix Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status.includes('SUCCESS');
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 204 FIX: SUCCESS!' : '❌ 204 FIX: FAILED!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show problem analysis
                        if (data.problem_analysis) {
                            html += `
                                <h4>🐛 Problem Analysis:</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px; margin: 10px 0;">
                                    <p><strong>Issue:</strong> ${data.problem_analysis.issue}</p>
                                    <p><strong>Log Evidence:</strong> ${data.problem_analysis.log_evidence}</p>
                                    <p><strong>Error Location:</strong> ${data.problem_analysis.error_location}</p>
                                    <p><strong>Root Cause:</strong> ${data.problem_analysis.root_cause}</p>
                                    <p><strong>Why Null:</strong> ${data.problem_analysis.why_null}</p>
                                </div>
                            `;
                        }
                        
                        // Show solution details
                        if (data.solution_details) {
                            html += `
                                <h4>✅ Solution Details:</h4>
                                <div style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 5px; margin: 10px 0;">
                                    <p><strong>Approach:</strong> ${data.solution_details.approach}</p>
                                    <p><strong>Location Header Format:</strong></p>
                                    <code style="display: block; background: #f8f9fa; padding: 5px; margin: 5px 0;">${data.solution_details.location_header_format}</code>
                                    <p><strong>Extraction Method:</strong> ${data.solution_details.extraction_method}</p>
                                    <p><strong>Fallback Method:</strong> ${data.solution_details.fallback_method}</p>
                                    <p><strong>Response Construction:</strong> ${data.solution_details.response_construction}</p>
                                </div>
                            `;
                        }
                        
                        // Show code changes
                        if (data.code_changes) {
                            html += `
                                <h4>💻 Code Changes:</h4>
                                <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px;">
                                    <p><strong>File:</strong> ${data.code_changes.file}</p>
                                    <p><strong>Method:</strong> ${data.code_changes.method}</p>
                                    
                                    <h5>❌ Before (Broken):</h5>
                                    <p>${data.code_changes.before.description}</p>
                                    <pre style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 3px;">${data.code_changes.before.code.join('\n')}</pre>
                                    
                                    <h5>✅ After (Fixed):</h5>
                                    <p>${data.code_changes.after.description}</p>
                                    <pre style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 3px;">${data.code_changes.after.code.join('\n')}</pre>
                                </div>
                            `;
                        }
                        
                        // Show regex tests
                        if (data.regex_tests) {
                            html += `
                                <h4>🧪 Location Header Parsing Tests:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Test URL</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Extracted ID</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Result</th>
                                    </tr>
                            `;
                            
                            data.regex_tests.forEach(test => {
                                const bgColor = test.success ? '#d4edda' : '#f8d7da';
                                html += `
                                    <tr style="background: ${bgColor};">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-size: 12px;">${test.url}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${test.extracted_id || 'N/A'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${test.success ? '✅ SUCCESS' : '❌ FAILED'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show simulation results
                        if (data.simulation_results) {
                            html += `
                                <h4>🎭 Response Scenario Simulations:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Scenario</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status Code</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected Behavior</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Outcome</th>
                                    </tr>
                            `;
                            
                            data.simulation_results.forEach(result => {
                                const bgColor = result.success === true ? '#d4edda' : 
                                              result.success === 'partial' ? '#fff3cd' : '#f8d7da';
                                html += `
                                    <tr style="background: ${bgColor};">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${result.scenario}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${result.status_code}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${result.expected}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${result.outcome}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show validation results
                        if (data.validations) {
                            html += `
                                <h4>✅ Validation Results:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Validation</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Implemented</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Correct</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.validations).forEach(([key, validation]) => {
                                const bgColor = validation.correct ? '#d4edda' : '#f8d7da';
                                html += `
                                    <tr style="background: ${bgColor};">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${validation.description}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.implemented ? '✅ Yes' : '❌ No'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ Yes' : '❌ No'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show what this fix solves
                        html += `
                            <h4>🎯 What This Fix Solves:</h4>
                            <div style="background: #fff3cd; padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
                                <p><strong>1. 204 Response Handling:</strong> Properly handles NetSuite's 204 No Content responses</p>
                                <p><strong>2. Location Header Parsing:</strong> Extracts customer ID from Location header URL</p>
                                <p><strong>3. Null Pointer Prevention:</strong> Prevents "array offset on null" errors</p>
                                <p><strong>4. Fallback Mechanism:</strong> Uses email search if Location header fails</p>
                                <p><strong>5. Backward Compatibility:</strong> Still works with 200 responses</p>
                            </div>
                        `;
                        
                        // Show next steps
                        if (data.validation_result === 'success') {
                            html += `
                                <h4>🚀 Next Steps (Success):</h4>
                                <div style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 5px;">
                                    <p>✅ <strong>The fix is ready!</strong> You can now:</p>
                                    <p>1. Test with real customer creation that returns 204</p>
                                    <p>2. Process orders with company customers</p>
                                    <p>3. Monitor logs to see successful person customer creation</p>
                                    <p>4. Verify customer IDs are properly extracted from Location headers</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <h4>🔧 Next Steps (Issues Found):</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px;">
                                    <p>❌ <strong>Issues detected:</strong> You should:</p>
                                    <p>1. Review the validation failures above</p>
                                    <p>2. Test the regex pattern with actual Location headers</p>
                                    <p>3. Verify the fallback email search works</p>
                                    <p>4. Check NetSuite API documentation for response formats</p>
                                </div>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ 204 Response Fix Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('204 response fix test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testRealCustomerCreation() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🧪 Testing real customer creation...';
            
            fetch('test-real-customer-creation.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Real customer creation test response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The real customer creation test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🧪 Real Customer Creation Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status.includes('SUCCESS');
                            const isPartial = data.overall_status.includes('PARTIAL');
                            const bgColor = isSuccess ? '#d4edda' : (isPartial ? '#fff3cd' : '#f8d7da');
                            const borderColor = isSuccess ? '#28a745' : (isPartial ? '#ffc107' : '#dc3545');
                            const textColor = isSuccess ? '#155724' : (isPartial ? '#856404' : '#721c24');
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 REAL TEST: SUCCESS!' : (isPartial ? '⚠️ REAL TEST: PARTIAL!' : '❌ REAL TEST: FAILED!')}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show parent company used
                        if (data.parent_company) {
                            html += `
                                <h4>🏢 Parent Company Used:</h4>
                                <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px;">
                                    <p><strong>ID:</strong> ${data.parent_company.id}</p>
                                    <p><strong>Company Name:</strong> ${data.parent_company.companyName || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${data.parent_company.email || 'N/A'}</p>
                                    <p><strong>isPerson:</strong> ${data.parent_company.isperson}</p>
                                </div>
                            `;
                        }
                        
                        // Show test person data
                        if (data.test_person_data) {
                            html += `
                                <h4>👤 Test Person Data:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <p><strong>Name:</strong> ${data.test_person_data.firstName} ${data.test_person_data.lastName}</p>
                                    <p><strong>Email:</strong> ${data.test_person_data.email}</p>
                                    <p><strong>Phone:</strong> ${data.test_person_data.phone}</p>
                                    <p><strong>isPerson:</strong> ${data.test_person_data.isPerson}</p>
                                    <p><strong>Parent ID:</strong> ${data.parent_id}</p>
                                </div>
                            `;
                        }
                        
                        // Show creation results
                        if (data.created_customer) {
                            html += `
                                <h4>✅ Customer Creation Results:</h4>
                                <div style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 5px;">
                                    <p><strong>✅ SUCCESS:</strong> Customer created successfully!</p>
                                    <p><strong>Customer ID:</strong> ${data.created_customer.id}</p>
                                    <p><strong>Creation Time:</strong> ${data.creation_duration_ms ? Math.round(data.creation_duration_ms) + 'ms' : 'N/A'}</p>
                                </div>
                            `;
                        } else if (data.creation_error) {
                            html += `
                                <h4>❌ Customer Creation Failed:</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px;">
                                    <p><strong>❌ ERROR:</strong> ${data.creation_error}</p>
                                </div>
                            `;
                        }
                        
                        // Show verification results
                        if (data.verified_customer) {
                            html += `
                                <h4>🔍 Customer Verification:</h4>
                                <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px;">
                                    <p><strong>Verified ID:</strong> ${data.verified_customer.id}</p>
                                    <p><strong>Name:</strong> ${data.verified_customer.firstName} ${data.verified_customer.lastName}</p>
                                    <p><strong>Email:</strong> ${data.verified_customer.email}</p>
                                    <p><strong>isPerson:</strong> ${data.verified_customer.isperson}</p>
                                    <p><strong>Parent:</strong> ${data.verified_customer.parent || 'None'}</p>
                                </div>
                            `;
                        }
                        
                        // Show validation results
                        if (data.validations) {
                            html += `
                                <h4>✅ Validation Results:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Validation</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actual</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Result</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.validations).forEach(([key, validation]) => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${validation.description}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.expected}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.actual}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show ensurePersonCustomer test results
                        if (data.ensured_customer) {
                            html += `
                                <h4>🔧 ensurePersonCustomer Test:</h4>
                                <div style="background: #d1ecf1; padding: 10px; border: 1px solid #bee5eb; border-radius: 5px;">
                                    <p><strong>✅ SUCCESS:</strong> ensurePersonCustomer method worked</p>
                                    <p><strong>Returned Customer ID:</strong> ${data.ensured_customer.id}</p>
                                    <p><strong>isPerson:</strong> ${data.ensured_customer.isperson || 'N/A'}</p>
                                    ${data.ensured_customer.id != data.parent_company?.id ? 
                                        '<p><strong>✅ Created new person customer</strong></p>' : 
                                        '<p><strong>⚠️ Used fallback (original customer)</strong></p>'
                                    }
                                </div>
                            `;
                        }
                        
                        // Show what this test proves
                        html += `
                            <h4>🎯 What This Test Proves:</h4>
                            <div style="background: #fff3cd; padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
                                <p><strong>1. Fix Implementation:</strong> The parent parameter fix is working</p>
                                <p><strong>2. API Integration:</strong> NetSuite accepts the corrected customer data</p>
                                <p><strong>3. Data Integrity:</strong> Created customers have correct parent relationships</p>
                                <p><strong>4. Method Functionality:</strong> ensurePersonCustomer method works end-to-end</p>
                            </div>
                        `;
                        
                        // Show next steps based on results
                        if (data.validation_result === 'success') {
                            html += `
                                <h4>🚀 Next Steps (Success):</h4>
                                <div style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 5px;">
                                    <p>✅ <strong>The fix is working!</strong> You can now:</p>
                                    <p>1. Process real orders with company customers</p>
                                    <p>2. Monitor logs to see person customers being created</p>
                                    <p>3. Verify sales orders use the person customers correctly</p>
                                </div>
                            `;
                        } else {
                            html += `
                                <h4>🔧 Next Steps (Issues Found):</h4>
                                <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px;">
                                    <p>❌ <strong>Issues detected:</strong> You should:</p>
                                    <p>1. Check the error details above</p>
                                    <p>2. Review the NetSuite API requirements</p>
                                    <p>3. Test with different customer data</p>
                                    <p>4. Check NetSuite permissions and settings</p>
                                </div>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Real Customer Creation Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Real customer creation test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testCustomerCreationFix() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔧 Testing customer creation fix...';
            
            fetch('test-customer-creation-fix.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Customer creation fix test response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The customer creation fix test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔧 Customer Creation Fix Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status.includes('SUCCESS');
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 CUSTOMER FIX: SUCCESS!' : '❌ CUSTOMER FIX: FAILED!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show the problem and solution
                        html += `
                            <h4>🐛 The Problem:</h4>
                            <div style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 5px; margin: 10px 0;">
                                <p><strong>Error:</strong> 400 Bad Request when creating person customers with parent</p>
                                <p><strong>Cause:</strong> Parent field was included in customer data AND passed as separate parameter</p>
                                <p><strong>Log Line:</strong> Line 38 in logs/app-2025-08-20.log</p>
                            </div>
                        `;
                        
                        // Show the fix comparison
                        if (data.comparison) {
                            html += `
                                <h4>🔧 The Fix:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Approach</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Method Call</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Parent in Data</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Parent Parameter</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Result</th>
                                    </tr>
                                    <tr style="background: #f8d7da;">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">OLD (Broken)</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><code>${data.comparison.old_broken_way.method_call}</code></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">✅ Yes (conflict!)</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">❌ ${data.comparison.old_broken_way.parent_parameter || 'null'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">❌ 400 Error</td>
                                    </tr>
                                    <tr style="background: #d4edda;">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">NEW (Fixed)</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;"><code>${data.comparison.new_fixed_way.method_call}</code></td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">❌ No</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">✅ ${data.comparison.new_fixed_way.parent_parameter}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">✅ Should work</td>
                                    </tr>
                                </table>
                            `;
                        }
                        
                        // Show code fix details
                        if (data.code_fix) {
                            html += `
                                <h4>💻 Code Changes Made:</h4>
                                <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px;">
                                    <p><strong>File:</strong> ${data.code_fix.file}</p>
                                    <p><strong>Method:</strong> ${data.code_fix.method}</p>
                                    
                                    <h5>❌ Before (Broken):</h5>
                                    <pre style="background: #f8d7da; padding: 10px; border: 1px solid #dc3545; border-radius: 3px;">${data.code_fix.before.content.join('\n')}</pre>
                                    
                                    <h5>✅ After (Fixed):</h5>
                                    <pre style="background: #d4edda; padding: 10px; border: 1px solid #28a745; border-radius: 3px;">${data.code_fix.after.content.join('\n')}</pre>
                                </div>
                            `;
                        }
                        
                        // Show validation results
                        if (data.validation_results) {
                            html += `
                                <h4>✅ Validation Results:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Validation</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actual</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Result</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.validation_results).forEach(([key, validation]) => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${validation.description}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.expected}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.actual}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show test scenarios
                        if (data.test_scenarios) {
                            html += `
                                <h4>🧪 Test Scenarios:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                            `;
                            
                            Object.entries(data.test_scenarios).forEach(([scenario, details]) => {
                                html += `
                                    <h5>${scenario.replace(/_/g, ' ').toUpperCase()}:</h5>
                                    <p><strong>Customer:</strong> ${details.customer_data.firstName} ${details.customer_data.lastName}</p>
                                    <p><strong>Email:</strong> ${details.customer_data.email}</p>
                                    <p><strong>Parent ID:</strong> ${details.parent_id || 'None'}</p>
                                `;
                            });
                            
                            html += '</div>';
                        }
                        
                        // Show mock data used
                        if (data.mock_data) {
                            html += `
                                <h4>📊 Mock Data Used:</h4>
                                <div style="background: #fff3cd; padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
                                    <h5>Company Customer:</h5>
                                    <p><strong>ID:</strong> ${data.mock_data.company_customer.id}</p>
                                    <p><strong>Company:</strong> ${data.mock_data.company_customer.companyName}</p>
                                    <p><strong>isPerson:</strong> ${data.mock_data.company_customer.isperson}</p>
                                    
                                    <h5>Order Data:</h5>
                                    <p><strong>Customer:</strong> ${data.mock_data.order_data.BillingFirstName} ${data.mock_data.order_data.BillingLastName}</p>
                                    <p><strong>Email:</strong> ${data.mock_data.order_data.BillingEmailAddress}</p>
                                </div>
                            `;
                        }
                        
                        // Show next steps
                        html += `
                            <h4>🚀 Next Steps:</h4>
                            <div style="background: #d1ecf1; padding: 10px; border: 1px solid #bee5eb; border-radius: 5px;">
                                <p>1. <strong>Test with real order:</strong> Try processing an order that has a company customer</p>
                                <p>2. <strong>Monitor logs:</strong> Check that person customers are created successfully</p>
                                <p>3. <strong>Verify in NetSuite:</strong> Confirm person customers appear with correct parent relationships</p>
                                <p>4. <strong>Test sales orders:</strong> Ensure sales orders use the person customers correctly</p>
                            </div>
                        `;
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Customer Creation Fix Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Customer creation fix test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testNewFeatures() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🆕 Testing new features implementation...';
            
            fetch('test-new-features.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('New features test response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The new features test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🆕 New Features Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status.includes('SUCCESS');
                            const bgColor = isSuccess ? '#d4edda' : '#fff3cd';
                            const borderColor = isSuccess ? '#28a745' : '#ffc107';
                            const textColor = isSuccess ? '#155724' : '#856404';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 NEW FEATURES: SUCCESS!' : '⚠️ NEW FEATURES: PARTIAL!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show validation results
                        if (data.validation_results) {
                            html += `
                                <h4>✅ Validation Results:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Feature</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actual</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Status</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.validation_results).forEach(([feature, validation]) => {
                                if (feature === 'custom_field') {
                                    html += `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">Custom Field</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.field_name} = ${validation.expected_value}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.field_name} = ${validation.actual_value}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                        </tr>
                                    `;
                                } else if (feature === 'isperson_logic') {
                                    html += `
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">isPerson Logic</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">Detect company & create person</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.detected_company ? 'Company detected' : 'Not detected'}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                        </tr>
                                    `;
                                }
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show implementation details
                        if (data.implementation_details) {
                            html += `
                                <h4>🔧 Implementation Details:</h4>
                                <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px;">
                                    <h5>1. Custom Field (custbodyship_immediate = 2):</h5>
                                    <p><strong>Location:</strong> ${data.implementation_details.custom_field.location}</p>
                                    <p><strong>Code:</strong> <code>${data.implementation_details.custom_field.line_added}</code></p>
                                    
                                    <h5>2. isPerson Validation:</h5>
                                    <p><strong>Method:</strong> ${data.implementation_details.isperson_validation.method_added}</p>
                                    <p><strong>Triggers:</strong> ${data.implementation_details.isperson_validation.triggers_on}</p>
                                    <p><strong>Search Query:</strong> <code>${data.implementation_details.isperson_validation.search_query}</code></p>
                                    <p><strong>Creates if not found:</strong> ${data.implementation_details.isperson_validation.creates_if_not_found ? 'Yes' : 'No'}</p>
                                </div>
                            `;
                        }
                        
                        // Show test scenario
                        if (data.test_data) {
                            html += `
                                <h4>🧪 Test Scenario:</h4>
                                <div style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px;">
                                    <h5>Company Customer (isPerson = false):</h5>
                                    <p><strong>ID:</strong> ${data.test_data.company_customer.id}</p>
                                    <p><strong>Company:</strong> ${data.test_data.company_customer.companyName}</p>
                                    <p><strong>Email:</strong> ${data.test_data.company_customer.email}</p>
                                    <p><strong>isPerson:</strong> ${data.test_data.company_customer.isperson}</p>
                                    
                                    <h5>Order Data:</h5>
                                    <p><strong>Customer Name:</strong> ${data.test_data.order_data.BillingFirstName} ${data.test_data.order_data.BillingLastName}</p>
                                    <p><strong>Email:</strong> ${data.test_data.order_data.BillingEmailAddress}</p>
                                </div>
                            `;
                        }
                        
                        // Show expected search query
                        if (data.expected_search) {
                            html += `
                                <h4>🔍 Expected Person Customer Search:</h4>
                                <div style="background: #fff3cd; padding: 10px; border: 1px solid #ffc107; border-radius: 5px;">
                                    <p><strong>Entity ID:</strong> ${data.expected_search.entityid}</p>
                                    <p><strong>Parent ID:</strong> ${data.expected_search.parent_id}</p>
                                    <p><strong>Query:</strong></p>
                                    <code style="display: block; background: #f8f9fa; padding: 5px; margin: 5px 0;">${data.expected_search.query}</code>
                                </div>
                            `;
                        }
                        
                        // Show would-create customer
                        if (data.would_create_customer) {
                            html += `
                                <h4>👤 Would Create Person Customer:</h4>
                                <div style="background: #d1ecf1; padding: 10px; border: 1px solid #bee5eb; border-radius: 5px;">
                                    <p><strong>First Name:</strong> ${data.would_create_customer.firstName}</p>
                                    <p><strong>Last Name:</strong> ${data.would_create_customer.lastName}</p>
                                    <p><strong>Email:</strong> ${data.would_create_customer.email}</p>
                                    <p><strong>Phone:</strong> ${data.would_create_customer.phone}</p>
                                    <p><strong>isPerson:</strong> ${data.would_create_customer.isPerson}</p>
                                    <p><strong>Parent ID:</strong> ${data.would_create_customer.parent.id}</p>
                                </div>
                            `;
                        }
                        
                        // Show sales order payload
                        if (data.sales_order_payload) {
                            html += `
                                <h4>📄 Sales Order Payload (with new custom field):</h4>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; max-height: 200px; overflow-y: auto;">${JSON.stringify(data.sales_order_payload, null, 2)}</pre>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ New Features Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('New features test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function findDropshipOrders() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔍 Searching for dropship orders...';
            
            fetch('find-dropship-orders.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Find dropship orders response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The dropship order search returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔍 Dropship Order Search Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const hasDropship = data.overall_status.includes('SUCCESS');
                            const bgColor = hasDropship ? '#d4edda' : '#fff3cd';
                            const borderColor = hasDropship ? '#28a745' : '#ffc107';
                            const textColor = hasDropship ? '#155724' : '#856404';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${hasDropship ? '🎉 DROPSHIP ORDERS FOUND!' : '⚠️ NO DROPSHIP ORDERS FOUND'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show search statistics
                        html += `
                            <h4>📊 Search Statistics:</h4>
                            <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                <tr style="background: #f0f0f0;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Metric</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Value</th>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>Total Orders Searched</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${data.total_orders_found || 0}</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>Dropship Orders Found</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${data.dropship_count || 0}</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>Payment Methods Found</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${Object.keys(data.payment_methods_found || {}).length}</td>
                                </tr>
                            </table>
                        `;
                        
                        // Show payment methods distribution
                        if (data.payment_methods_found) {
                            html += `
                                <h4>💳 Payment Methods Distribution:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Payment Method</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Count</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Percentage</th>
                                    </tr>
                            `;
                            
                            const total = Object.values(data.payment_methods_found).reduce((sum, count) => sum + count, 0);
                            Object.entries(data.payment_methods_found).forEach(([method, count]) => {
                                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
                                const isDropship = method === 'Dropship to Customer';
                                html += `
                                    <tr style="${isDropship ? 'background: #fff3cd;' : ''}">
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: ${isDropship ? 'bold' : 'normal'};">${method}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${count}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${percentage}%</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show dropship orders found
                        if (data.dropship_orders && data.dropship_orders.length > 0) {
                            html += `
                                <h4>🚚 Dropship Orders Found:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Order ID</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Order Date</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Has Address</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Action</th>
                                    </tr>
                            `;
                            
                            data.dropship_orders.forEach(order => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${order.OrderID}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${order.OrderDate}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">$${order.OrderAmount}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${order.has_shipment_address ? '✅ Yes' : '❌ No'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">
                                            <button onclick="testSyncSpecificOrder('${order.OrderID}')" style="padding: 4px 8px; font-size: 12px;">Test Sync</button>
                                        </td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                            
                            if (data.recommended_test_order) {
                                html += `
                                    <div style="background: #d1ecf1; padding: 10px; border: 1px solid #bee5eb; border-radius: 5px; margin-top: 10px;">
                                        <h5 style="margin-top: 0; color: #0c5460;">💡 Recommended Test Order</h5>
                                        <p>Order ID: <strong>${data.recommended_test_order}</strong></p>
                                        <p>This order can be used to test the dropship functionality.</p>
                                        <button onclick="testSyncSpecificOrder('${data.recommended_test_order}')" style="padding: 8px 16px;">Test Sync This Order</button>
                                    </div>
                                `;
                            }
                        }
                        
                        // Show implementation status
                        html += `
                            <h4>🔧 Implementation Status:</h4>
                            <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px;">
                                <p><strong>Dropship Detection:</strong> ✅ Implemented</p>
                                <p><strong>Address Formatting:</strong> ✅ Implemented</p>
                                <p><strong>Logging:</strong> ✅ Enhanced for dropship orders</p>
                                <p><strong>Test Coverage:</strong> ✅ Unit tests available</p>
                            </div>
                        `;
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Search Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Dropship Order Search Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Find dropship orders error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function testSyncSpecificOrder(orderId) {
            alert(`Testing sync for order ${orderId} - this would trigger a specific order sync test.`);
            // You could implement a specific order sync test here
        }

        function testDropshipFunctionality() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🚚 Testing dropship functionality...';
            
            fetch('test-dropship-functionality.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Dropship functionality test response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The dropship functionality test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🚚 Dropship Functionality Test Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status.includes('SUCCESS');
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
                                <div style="background: ${bgColor}; padding: 15px; border: 2px solid ${borderColor}; margin: 15px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: ${textColor};">
                                        ${isSuccess ? '🎉 DROPSHIP TEST: SUCCESS!' : '❌ DROPSHIP TEST: FAILED!'}
                                    </h4>
                                    <p style="margin-bottom: 0;"><strong>${data.overall_status}</strong></p>
                                </div>
                            `;
                        }
                        
                        // Show test results comparison
                        if (data.test_results) {
                            html += `
                                <h4>📊 Test Results Comparison:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Order Type</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Payment Method</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Is Dropship</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Addressee</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Source</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.test_results).forEach(([type, result]) => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${type.toUpperCase()}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${result.payment_method}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${result.is_dropship ? '✅ Yes' : '❌ No'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; max-width: 300px; word-wrap: break-word;">${result.shipping_address?.addressee || 'N/A'}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${result.addressee_source}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show validation results
                        if (data.validation_results) {
                            html += `
                                <h4>✅ Validation Results:</h4>
                                <table style="border-collapse: collapse; width: 100%; margin: 10px 0;">
                                    <tr style="background: #f0f0f0;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">Order Type</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Expected Addressee</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Actual Addressee</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">Result</th>
                                    </tr>
                            `;
                            
                            Object.entries(data.validation_results).forEach(([type, validation]) => {
                                html += `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${type.toUpperCase()}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; max-width: 200px; word-wrap: break-word;">${validation.expected_addressee}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px; max-width: 200px; word-wrap: break-word;">${validation.actual_addressee}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${validation.correct ? '✅ PASSED' : '❌ FAILED'}</td>
                                    </tr>
                                `;
                            });
                            
                            html += '</table>';
                        }
                        
                        // Show implementation details
                        html += `
                            <h4>🔧 Implementation Details:</h4>
                            <div style="background: #e7f3ff; padding: 10px; border: 1px solid #0066cc; border-radius: 5px;">
                                <h5>Standard Orders (Non-Dropship):</h5>
                                <p><strong>Condition:</strong> <code>BillingPaymentMethod !== "Dropship to Customer"</code></p>
                                <p><strong>Addressee:</strong> <code>ShipmentFirstName + " " + ShipmentLastName</code></p>
                                
                                <h5>Dropship Orders:</h5>
                                <p><strong>Condition:</strong> <code>BillingPaymentMethod === "Dropship to Customer"</code></p>
                                <p><strong>Addressee:</strong> <code>ShipmentAddress, ShipmentAddress2, ShipmentCity, ShipmentState, ShipmentZipCode</code></p>
                                <p><strong>Format:</strong> Comma-separated address components</p>
                            </div>
                        `;
                        
                        // Show sample orders used
                        if (data.sample_orders) {
                            html += `
                                <details>
                                    <summary>📋 Sample Orders Used in Test</summary>
                                    <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 300px; overflow-y: auto;">${JSON.stringify(data.sample_orders, null, 2)}</pre>
                                </details>
                            `;
                        }
                        
                        // Show raw data
                        html += `
                            <details>
                                <summary>📊 Raw Test Data</summary>
                                <pre style="background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 400px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `
                            <h3>❌ Dropship Functionality Test Failed</h3>
                            <p><strong>Error:</strong> ${data.error}</p>
                        `;
                    }
                } catch (e) {
                    resultDiv.innerHTML = `
                        <h3>❌ JSON Parse Error</h3>
                        <p><strong>Error:</strong> ${e.message}</p>
                        <p><strong>Response:</strong></p>
                        <pre>${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Dropship functionality test error:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Network Error</h3>
                    <p>${error.message}</p>
                `;
            });
        }

        function retrySyncOrder1080931() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '🔄 Retrying sync for 3DCart order 1080931 with fixed configuration...';
            
            fetch('retry-sync-1080931.php', {
                method: 'POST'
            })
            .then(response => response.text())
            .then(text => {
                console.log('Order 1080931 retry sync response:', text);
                
                if (text.length === 0) {
                    resultDiv.innerHTML = `
                        <h3>❌ Empty Response</h3>
                        <p>The retry sync test returned no output.</p>
                    `;
                    return;
                }
                
                try {
                    const data = JSON.parse(text);
                    
                    if (data.success) {
                        let html = `
                            <h3>🔄 Order 1080931 Retry Sync Results</h3>
                            
                            <h4>📋 Process Steps:</h4>
                            <ul>
                        `;
                        
                        data.steps.forEach(step => {
                            html += `<li>${step}</li>`;
                        });
                        
                        html += '</ul>';
                        
                        // Show overall status prominently
                        if (data.overall_status) {
                            const isSuccess = data.overall_status === 'SUCCESS';
                            const bgColor = isSuccess ? '#d4edda' : '#f8d7da';
                            const borderColor = isSuccess ? '#28a745' : '#dc3545';
                            const textColor = isSuccess ? '#155724' : '#721c24';
                            
                            html += `
    